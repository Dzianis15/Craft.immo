<script>
(() => {
  /* =========================
     I18N + переключатель языков
     ========================= */

  const LANG = {
    fr: {
      headerTitle: "Le Grand Clos — Votre sélection de lot",
      headerHint: "Maisons T4 (84 m²), T5 Classique (106 m²), T5 Contemporain (104 m²) — Le Quiou (22630)",

      step0Title: "Souhaitez-vous obtenir des informations sur un lot disponible ?",
      intentYes: "Oui, je cherche un lot",
      intentNo: "Non, juste découvrir le projet",

      step1Title: "Quel type de maison vous intéresse ?",
      typeT4: "T4 — 84 m²",
      typeT5c: "T5 Classique — 106 m²",
      typeT5cont: "T5 Contemporain — 104 m²",

      step2Title: "Souhaitez-vous choisir un lot précis ?",
      hasLotYes: "Oui, choisir un lot",
      hasLotNo: "Peu importe, proposez-moi",

      step3Title: "Sélectionnez votre lot",
      reserved: "Réservé",

      step4Title: "Souhaitez-vous la version Classique ou Premium ?",
      packClassique: "Classique",
      packPremium: "Premium",

      step5Title: "Votre sélection",
      priceHint: "Prix indicatifs TTC au 01/08/2025. Sous réserve de disponibilité et d’éligibilité.",

      step6Title: "Recevoir la documentation par e-mail ou être rappelé",
      fLastName: "Nom*",
      fFirstName: "Prénom*",
      fPhone: "Téléphone*",
      fEmail: "E-mail*",
      optDocs: "Recevoir la documentation complète",
      optFiche: "Fiche technique de la maison",
      optVEFA: "Informations sur le financement VEFA",
      optCall: "Être rappelé par un conseiller",
      optVisit: "Demander une visite du terrain",
      consent: "J’accepte d’être recontacté au sujet de ma demande (RGPD).",
      send: "Envoyer ma demande",

      msgOk: "Merci ! Votre demande a été envoyée. Un conseiller CRAFT vous contactera rapidement.",
      msgFail: "Oups… impossible d’envoyer la demande. Réessayez plus tard ou contactez-nous par téléphone.",
      msgNeed: "Merci de renseigner tous les champs obligatoires (*) et d’accepter la recontactation.",
      msgNet: "Erreur réseau. Vérifiez la connexion et réessayez.",

      thanksTitle: "Merci pour votre demande !",
      thanksLead: "Notre équipe CRAFT vous contactera sous peu.",
      thanksClose: "Merci de votre confiance !<br>Vous pouvez fermer cette page en toute sécurité."
    },
    en: {
      headerTitle: "Le Grand Clos — Select your lot",
      headerHint: "Homes T4 (84 m²), T5 Classic (106 m²), T5 Contemporary (104 m²) — Le Quiou (22630)",

      step0Title: "Would you like to get information about an available lot?",
      intentYes: "Yes, I’m looking for a lot",
      intentNo: "No, just exploring the project",

      step1Title: "Which house type are you interested in?",
      typeT4: "T4 — 84 m²",
      typeT5c: "T5 Classic — 106 m²",
      typeT5cont: "T5 Contemporary — 104 m²",

      step2Title: "Do you want to pick a specific lot?",
      hasLotYes: "Yes, choose a lot",
      hasLotNo: "No preference, suggest one",

      step3Title: "Select your lot",
      reserved: "Reserved",

      step4Title: "Do you prefer the Classic or Premium version?",
      packClassique: "Classic",
      packPremium: "Premium",

      step5Title: "Your selection",
      priceHint: "Indicative TTC prices as of 01/08/2025. Subject to availability and eligibility.",

      step6Title: "Receive documentation by email or request a call back",
      fLastName: "Last name*",
      fFirstName: "First name*",
      fPhone: "Phone*",
      fEmail: "Email*",
      optDocs: "Receive full documentation",
      optFiche: "House technical datasheet",
      optVEFA: "VEFA financing information",
      optCall: "Be called back by an advisor",
      optVisit: "Request a site visit",
      consent: "I agree to be contacted regarding my request (GDPR).",
      send: "Send my request",

      msgOk: "Thanks! Your request has been sent. A CRAFT advisor will contact you shortly.",
      msgFail: "Oops… couldn’t send your request. Please try again later or call us.",
      msgNeed: "Please fill all required fields (*) and accept to be contacted.",
      msgNet: "Network error. Please check your connection and try again.",

      thanksTitle: "Thank you for your request!",
      thanksLead: "Our CRAFT team will contact you shortly.",
      thanksClose: "Thank you for your trust!<br>You can safely close this page."
    }
  };

  // --- helpers ---
  const $ = (s, root = document) => root.querySelector(s);
  const STORAGE_KEY = "craft-immo-lang";

  function setLabelAfterInput(labelEl, text){
    if(!labelEl) return;
    const inp = labelEl.querySelector('input');
    if(!inp) return;
    Array.from(labelEl.childNodes).forEach(n=>{
      if(n === inp) return;
      if(n.nodeType === 1 && n.classList.contains('_t')) return;
      labelEl.removeChild(n);
    });
    let span = labelEl.querySelector('span._t');
    if(!span){
      span = document.createElement('span');
      span.className = '_t';
      span.style.marginLeft = '6px';
      labelEl.appendChild(span);
    }
    span.textContent = ' ' + text;
  }

  function getInitialLang(){
    const urlLang = (new URLSearchParams(location.search).get("lang")||"").toLowerCase();
    if(urlLang && LANG[urlLang]) return urlLang;
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved && LANG[saved]) return saved;
    const nav = (navigator.language||"fr").toLowerCase();
    if(nav.startsWith("fr")) return "fr";
    return "en";
  }

  let currentLang = getInitialLang();

  function translateUI(){
    const T = LANG[currentLang];

    // header
    const h1 = document.querySelector("header h1");
    const hint = document.querySelector("header .hint");
    if(h1) h1.textContent = T.headerTitle;
    if(hint) hint.textContent = T.headerHint;

    // step 0
    const s0 = document.querySelector("#step0 .step-title");
    if(s0) s0.textContent = T.step0Title;
    setLabelAfterInput(document.querySelector('input[name="intent"][value="yes"]')?.closest('label'), T.intentYes);
    setLabelAfterInput(document.querySelector('input[name="intent"][value="no"]')?.closest('label'),  T.intentNo);

    // step 1
    const s1 = document.querySelector("#step1 .step-title");
    if(s1) s1.childNodes[0].nodeValue = T.step1Title + " ";
    setLabelAfterInput(document.querySelector('input[name="type"][value="T4"]')?.closest('label'),               T.typeT4);
    setLabelAfterInput(document.querySelector('input[name="type"][value="T5_classique"]')?.closest('label'),    T.typeT5c);
    setLabelAfterInput(document.querySelector('input[name="type"][value="T5_contemporain"]')?.closest('label'), T.typeT5cont);

    // step 2
    const s2 = document.querySelector("#step2 .step-title");
    if(s2) s2.textContent = T.step2Title;
    setLabelAfterInput(document.querySelector('input[name="hasLot"][value="yes"]')?.closest('label'), T.hasLotYes);
    setLabelAfterInput(document.querySelector('input[name="hasLot"][value="no"]')?.closest('label'),  T.hasLotNo);

    // step 3
    const s3 = document.querySelector("#step3 .step-title");
    if(s3) s3.textContent = T.step3Title;

    // step 4
    const s4 = document.querySelector("#step4 .step-title");
    if(s4) s4.textContent = T.step4Title;
    setLabelAfterInput(document.querySelector('input[name="pack"][value="classique"]')?.closest('label'), T.packClassique);
    setLabelAfterInput(document.querySelector('input[name="pack"][value="premium"]')?.closest('label'),  T.packPremium);

    // step 5
    const s5 = document.querySelector("#recap .step-title");
    if(s5) s5.textContent = T.step5Title;
    const priceHint = document.querySelector("#recap .hint");
    if(priceHint) priceHint.textContent = T.priceHint;

    // step 6
    const s6 = document.querySelector("#contact .step-title");
    if(s6) s6.textContent = T.step6Title;

    // form labels
    const labLast  = document.querySelector('input[name="lastName"]')?.closest("label");
    const labFirst = document.querySelector('input[name="firstName"]')?.closest("label");
    const labPhone = document.querySelector('input[name="phone"]')?.closest("label");
    const labEmail = document.querySelector('input[name="email"]')?.closest("label");
    if(labLast)  labLast.childNodes[0].nodeValue  = T.fLastName;
    if(labFirst) labFirst.childNodes[0].nodeValue = T.fFirstName;
    if(labPhone) labPhone.childNodes[0].nodeValue = T.fPhone;
    if(labEmail) labEmail.childNodes[0].nodeValue = T.fEmail;

    // checkboxes
    setLabelAfterInput(document.querySelector('input[name="opt_docs"]')?.closest('label'),  T.optDocs);
    setLabelAfterInput(document.querySelector('input[name="opt_fiche"]')?.closest('label'), T.optFiche);
    setLabelAfterInput(document.querySelector('input[name="opt_vefa"]')?.closest('label'),  T.optVEFA);
    setLabelAfterInput(document.querySelector('input[name="opt_call"]')?.closest('label'),  T.optCall);
    setLabelAfterInput(document.querySelector('input[name="opt_visit"]')?.closest('label'), T.optVisit);

    // consent
    const consentLab = document.querySelector('input[name="consent"]')?.closest("label");
    if(consentLab) setLabelAfterInput(consentLab, T.consent);

    // submit button
    const submitBtn = document.querySelector('#leadForm button[type="submit"]');
    if(submitBtn) submitBtn.textContent = T.send;

    // статусные строки (используются в другом скрипте)
    window.__I18N__ = {
      msgOk: T.msgOk, msgFail: T.msgFail, msgNeed: T.msgNeed, msgNet: T.msgNet,
      reserved: T.reserved, thanksTitle: T.thanksTitle, thanksLead: T.thanksLead, thanksClose: T.thanksClose
    };

    // подсветка кнопок языка
    const fr = document.getElementById("langFR");
    const en = document.getElementById("langEN");
    if(fr && en){
      fr.style.opacity = currentLang === "fr" ? 1 : .7;
      en.style.opacity = currentLang === "en" ? 1 : .7;
      if(currentLang === "en"){ en.style.background = "#111"; fr.style.background = ""; }
      else { fr.style.background = "#111"; en.style.background = ""; }
    }
  }

  function setLang(lang){
    if(!LANG[lang]) return;
    currentLang = lang;
    localStorage.setItem(STORAGE_KEY, lang);
    const url = new URL(location.href);
    url.searchParams.set('lang', lang);
    history.replaceState({}, "", url.toString());
    translateUI();
  }

  function bindLangButtons(){
    document.getElementById("langFR")?.addEventListener("click", () => setLang("fr"));
    document.getElementById("langEN")?.addEventListener("click", () => setLang("en"));
  }

  document.addEventListener("DOMContentLoaded", () => {
    bindLangButtons();
    translateUI();
  });

  // экспорт на всякий случай
  window.setLang = setLang;
  window.LANG = LANG;
})();
</script>
